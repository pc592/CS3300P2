<html>
  <head>
    <title>INFO 3300 - Data-driven Web Pages</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <style>

    /*body { font-size: 100%;}*/

    .divContainer {
      position:relative;
      width:95%;
      height:95%;
    }
    .divSplit1 {
      position:absolute;
      width:50%;
      height:100%;
      left:0%;
    }
    .divSplit2 {
      position:absolute;
      width:50%;
      height:100%;
      left:50%;
    }
    .but {
      width: 2vmin;
      height: 2vmin;
    }
    .buttons {
      position:absolute;
      top:35%;
      left:50%;
      margin-left:-35%;
      font-family: Arial;
      color: black;
      font-size: 2vmin;
    }
    .donut {
      position:absolute;
      width: 60%;
      top:10%;
      left:50%;
      margin-left:-20%;
      padding-left: 50px;
      padding-right: 50px;
    }
    .slider {
      position:absolute;
      top:90%;
      left:10%;
      width:80%;
      padding: 5px;
    }
    .sliderLabelMin {
      position:absolute;
      margin-left: 3px;
      margin-top: -5px;
      top:90%;
      left:10%;
      font-family: Arial;
      color: black;
      font-size: 1.5vh;
    }
    .sliderLabelCur {
      position:absolute;
      margin-left: -8px;
      margin-top: 30px;
      top:90%;
      left:50%;
      font-family: Arial;
      color: black;
      font-size: 1.5vh;
    }
    .sliderLabelMax {
      position:absolute;
      margin-left: -18px;
      margin-top: -5px;
      top:90%;
      left:90%;
      font-family: Arial;
      color: black;
      font-size: 1.5vh;     
    }
    .image:hover {
      x:20%;
      y:20%;
      width:60%;
      height:60%;
    }

    /*.labelArc {
      font-size:3vh;
      opacity:0.8;
    }

    .labelArc:hover {
        font-size:5vh;
        opacity:1;
    }*/

    .piechartLabels {
      font-family: Arial;
      color: black;
      /*font-size: 3vh;*/
      /*opacity: .8;*/
    }

    .piechartLabels:hover {
      font-size: 15vh;
      /*opacity: .8;*/
    }

    /*.pieChartArcs { opacity:0.9; }

    .piechartArcs:hover { opacity:1; }*/

  </style>

  <body>
    <div id="visualization" class="divContainer">
      <div id="div1" class="divSplit1">
        <form id="buttons1" action="" class="buttons">
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Brown" class="but"> Brown<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Columbia" class="but"> Columbia<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Cornell" class="but" checked> Cornell<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Dartmouth" class="but"> Dartmouth<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Harvard" class="but"> Harvard<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="UPenn" class="but"> UPenn<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Princeton" class="but"> Princeton<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Yale" class="but"> Yale<br>
        </form>
        <svg id="donut1" class="donut"><p id="total_stats1"></p></svg>
        <input id ="slider1" type="range" min="1994" max="2016" value="2005" class="slider">
        <div class=sliderLabelMin id="sliderMin1" text-anchor="middle" alignment-baseline="middle">1994</div>
        <div class=sliderLabelCur id="sliderCur1" text-anchor="middle" alignment-baseline="middle">2005</div>
        <div class=sliderLabelMax id="sliderMax1" text-anchor="middle" alignment-baseline="middle">2016</div>
      </div>

      <div id="div2" class="divSplit2">
        <form id="buttons2" action="" class="buttons">
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Brown" class="but"> Brown<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Columbia" class="but"> Columbia<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Cornell" class="but" checked> Cornell<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Dartmouth" class="but"> Dartmouth<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Harvard" class="but"> Harvard<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="UPenn" class="but"> UPenn<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Princeton" class="but"> Princeton<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Yale" class="but"> Yale<br>
        </form>
        <svg id="donut2" class="donut"><p id="total_stats2"></p></svg>
        <input id ="slider2" type="range" min="1994" max="2016" value="2005" class="slider">
        <div class=sliderLabelMin id="sliderMin2" text-anchor="middle" alignment-baseline="middle">1994</div>
        <div class=sliderLabelCur id="sliderCur2" text-anchor="middle" alignment-baseline="middle">2005</div>
        <div class=sliderLabelMax id="sliderMax2" text-anchor="middle" alignment-baseline="middle">2016</div>
      </div>
    </div>

    <script>
      var data;
      var year;
      var race;
      var gender;
      var returnedData;
      var racedic = d3.map();

      d3.csv("data/RaceByYear.csv", parseRow, callback);

      function parseRow(row) {
        var newRow = {};

        newRow["Gender"] = row["Gender"]
        newRow["Year"] = Number(row["Year"])

        var splitStr = " ("
        newRow["RaceName"] = row["Race"].split(splitStr)[0];

        newRow["Race"] = row["Race"].split('(')[0] + "["+newRow["Year"]+"]";

        newRow["Brown"] = Number(row["Brown University"])
        newRow["Columbia"] = Number(row["Columbia University in the City of New York"])
        newRow["Cornell"] = Number(row["Cornell University"])
        newRow["Dartmouth"] = Number(row["Dartmouth College"])
        newRow["Harvard"] = Number(row["Harvard University"])
        newRow["Princeton"] = Number(row["Princeton University"])
        newRow["UPenn"] = Number(row["University of Pennsylvania"])
        newRow["Yale"] = Number(row["Yale University"])

        return newRow;
      }

      function callback(error, rawData) {
        data = rawData;

        year = d3.nest()
        .key(function (d) { return d.Year; })
        .entries(data);

        race = d3.nest()
        .key(function (d) { return d.Race; })
        .entries(data);

        gender = d3.nest()
        .key(function (d) { return d.Gender; })
        .entries(data);

        createVisualization("1");
        createVisualization("2");
      }


      /* Helper functions for translating and rotating with inputs */
      function translate (x,y) { return "translate(" + x + "," + y + ")"; };
      function rotate (a,x,y) { return "rotate(" + a + " " + x + "," + y + ")"};

      //don't think we need school_list or school_maps anymore
      var school_list= ["Columbia", "Dartmouth", "Brown", "Cornell",
                        "Harvard", "Princeton", "UPenn", "Yale"]
      // var school_maps = [];


      function race_shortened(race) {
        var split_race= race.split(new RegExp("[ ]{1,}"))
        if (split_race.length >= 3) {
          return split_race[1].substring(0,3) + "." +
                  split_race[split_race.length - 1].substring(0,3) + "."
        }
        var shortened= ""
        for (var i = 0; i < split_race.length; i++) {
          shortened = shortened + split_race[i].substring(0,2) + "."
        }
        return shortened
      }


      function createVisualization(num) {

        var winHeight = window.innerHeight-10;
        var winWidth = window.innerWidth-10;
        var side = Math.min(winHeight,winWidth);

        //for makeDataSchool
        //Will store race names as the value, index number as key
        //Indexes will match the keys of the data created in makeDataSchool

        // year from slider
        var yearInput= 0;

        var totalStats=0;
        var partialStats=0;

        //TODO: 2008 and 2009 have double the number of races..!

        var slideInput = d3.select("#slider"+num)
          .on("input", function(){
            //Corresponds with a value 0-22 (this value goes in the x for year[x] in the comment above)
            yearInput = this.value - 1994;
            document.getElementById("sliderCur"+num).innerText = this.value;
            d3.select("#sliderCur"+num).style("left",100-(80/(2016-1994)*(2016-this.value)+10) + "%");
            d3.select("#sliderCur"+num).style("margin-left",(yearInput*(-1)+3) + "px");

            //perform update
            render()
          });

        // school name from radio buttons
        var schoolInput = "Cornell";
        // var schoolInput = school_list[Math.floor(Math.random()*8)]
        var radioInput = d3.selectAll("#schoolName" + num)
          .on("change", function(){
            schoolInput = this.value;
            render()
          });

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        // draw and append the container
        // play with width/height percentages to make room for buttons/sliders/selectors
        // **must be percentages to work with viewBox;
        var svg = d3.select("#donut"+num)
          .attr("width", "75%")   // each svg takes up 50% of the window
          .attr("height", "75%")  // each svg takes up 75% of the window
          .attr("viewBox", "0 0 "+side+" "+side)   // allows for relative resizing
          .append("g")
        // set the thickness of the inner and outer radii
        var oRadius = side / 2;
        //console.log(oRadius)
        var iRadius = side / 2.75;
        //console.log(iRadius)

        // construct arc generator
        var arc = d3.arc()
          .outerRadius(oRadius)
          .innerRadius(iRadius);

        var arcOver = d3.arc()
        .outerRadius(oRadius + 10)
        .innerRadius(iRadius);

        var labelArc = d3.arc()
          .outerRadius(oRadius*1.2)
          .innerRadius(iRadius);

        // creates the pie chart container
        var g = svg.append("g")
          .attr("transform", translate(side/2,side/2));

        // construct default pie laoyut
        var pie = d3.pie().value(function(d){ return d; }).sort(null);

        render();


        // Store the displayed angles in _current.
        // Then, interpolate from _current to the new angles.
        // During the transition, _current is updated in-place by d3.interpolate.
        function arcTween(a) {
          var i = d3.interpolate(this._current, a);
          this._current = i(0);
          return function(t) {
            return arc(i(t));
          };
        }

        var indexesSelected = [];
        function render() {

          // generate new random data
          //donut_data = makeData(+document.getElementById("datacount").value);
          donut_data = makeDataSchool(school_list,yearInput,schoolInput,num);
          // add transition to new path
          g.datum(donut_data).selectAll("path")
            .data(pie)
            .transition().duration(1000)
            .attrTween("d", arcTween);

          g.datum(donut_data).selectAll("g").remove()

          // add any new paths
          var paths = g.datum(donut_data).selectAll("path")
            .data(pie(donut_data));

          indexesSelected = [];
          // create/update pie chart groups
          var pathG = paths.enter().append("g")
            .attr("id",function(d,i){return "pathG"+i});

          pathG.append("path")
              .attr("class","piechart labelArc")
            .merge(pathG)
              .attr("fill", function(d,i){ return color(i); })
              .attr("d", arc)
              .on("mouseenter", function(d) {
                // console.log(this.parentNode)
                d3.select(this.parentNode).select('text')
                  .style("font-size", "10vh")
                d3.select(this)
                   .attr("d", arcOver)
                   .attr("stroke-width",6);
              })
              .on("mouseleave", function(d) {
                if(indexesSelected.indexOf(d.index) == -1){
                  d3.select(this.parentNode).select('text')
                    .style("font-size", "4vh")
                  d3.select(this).transition()
                     .attr("d", arc)
                     .attr("stroke","none");
                }
              })
              .on("click", function(d){
                d3.select(this.parentNode).select('text')
                  .style("font-size", "10vh")
                d3.select(this)
                 .attr("d", arcOver)
                 .attr("stroke-width",6);
                if(indexesSelected.indexOf(d.index) == -1){
                  indexesSelected.push(d.index);
                  partialStats += donut_data[d.index];
                  var changeStat = d3.select("#total_stats"+num).text("Number of admitted students of Selected race(s): " + partialStats);
                }
              })
              .each(function(d){ this._current = d; })

          pathG.append("text")
              .attr("class","piechartLabels")
              .attr("dy", ".35em")
            .merge(pathG)
              .attr("transform", function(d) {
                var pos = arc.centroid(d);
                return "translate(" + pos + ")";
              })
              .style("text-anchor", "middle")
              .text(function(d) {
                  return race_shortened(racedic.get(d.index));
              })
              .each(function(d){ this._current = d; });

          svg.selectAll("image").remove();
          var image = svg.selectAll("image")
            .data([schoolInput]);
          image.enter()
            .append("image")
              .attr("class","image")
              .attr("width","50%")
              .attr("height","50%")
              .attr("x","25%")
              .attr("y","25%")
            .merge(image)
              .attr("xlink:href", "images/"+schoolInput+".png")
            .on("click", function(d){
              render();
            });
        }

      }

      //the circle should be the diversity distribution from the school
      //selected, during the selected year
      function makeDataSchool(school_list,yearInput,schoolInput,num){
        totalStats = 0;
        //will use yearInput in place of the 0 in all of the following
        var races= Object.values(year[yearInput])[1];
        returnedData = d3.range(races.length).map(function(item) {
          var rac = Object.values(year[yearInput])[1][item];
          var abvName = rac.RaceName;
          racedic.set(item, abvName);
          totalStats += Object.values(year[yearInput])[1][item][schoolInput];
          return Object.values(year[yearInput])[1][item][schoolInput];
        });
        d3.select("#total_stats"+num).text("Total Number of Admitted students " + totalStats);
        return returnedData;
      };

    </script>
  </body>
</html>