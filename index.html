<html>
  <head>
    <title>INFO 3300 - Data-driven Web Pages</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <style>

    /*body { font-size: 100%;}*/

    .divContainer {
      position:relative;
      width:100%;
      height:50%;
      top:20%;
    }
    .divSplit1 {
      position:absolute;
      width:50%;
      height:100%;
      left:0%;
    }
    .divSplit2 {
      position:absolute;
      width:50%;
      height:100%;
      left:50%;
    }
    .buttons {
      position:absolute;
      top:25%;
      left:10%;
      font-family: Arial;
      color: black;
      font-size: 1.75vh;
    }
    .donut {
      position:absolute;
      top:10%;
      left:25%;
    }
    .slider {
      position:absolute;
      top:90%;
      left:10%;
      width:80%;
    }

    .piechartLabels {
      font-family: Arial;
      color: black;
      font-size: 2vh;
    }
    .piechartArcs:hover { opacity:0.9; }

  </style>

  <body>
    <!--<div>
      Number of datapoints:
      <input id="datacount" onkeyup="render()" value="15" name="datapoints"></input>
    </div>-->
    <div id="visualization" class="divContainer">
      <div id="div1" class="divSplit1">
        <form id="buttons1" action="" class="buttons">
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Brown"> Brown<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Columbia"> Columbia<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Cornell" checked> Cornell<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Dartmouth"> Dartmouth<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Harvard"> Harvard<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="UPenn"> UPenn<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Princeton"> Princeton<br>
          <input type="radio" id="schoolName1" name="schoolInputValue1" value="Yale"> Yale<br>
        </form>
        <svg id="donut1" class="donut"></svg>
        <input id ="slider1" type="range" min="1996" max="2016" value="2005" class="slider">
      </div>

      <div id="div2" class="divSplit2">
        <form id="buttons2" action="" class="buttons">
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Brown"> Brown<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Columbia"> Columbia<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Cornell" checked> Cornell<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Dartmouth"> Dartmouth<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Harvard"> Harvard<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="UPenn"> UPenn<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Princeton"> Princeton<br>
          <input type="radio" id="schoolName2" name="schoolInputValue1" value="Yale"> Yale<br>
        </form>
        <svg id="donut2" class="donut"></svg>
        <input id ="slider2" type="range" min="1996" max="2016" value="2005" class="slider">
      </div>
    </div>

    <script>
      var data;
      var year;
      var race;
      var gender;
      var returnedData; //for makeDataSchool

      d3.csv("data/RaceByYear.csv", parseRow, callback);

      function parseRow(row) {
        var newRow = {};

        newRow["Gender"] = row["Gender"]
        newRow["Year"] = Number(row["Year"])

        // var splitStr;
        // if (newRow["Gender"] == "Male") { splitStr = ' men';
        // } else { splitStr = ' women'; }
        var splitStr = " ("
        newRow["RaceName"] = row["Race"].split(splitStr)[0];

        newRow["Race"] = row["Race"].split('(')[0] + "["+newRow["Year"]+"]";

        newRow["Brown"] = Number(row["Brown University"])
        newRow["Columbia"] = Number(row["Columbia University in the City of New York"])
        newRow["Cornell"] = Number(row["Cornell University"])
        newRow["Dartmouth"] = Number(row["Dartmouth College"])
        newRow["Harvard"] = Number(row["Harvard University"])
        newRow["Princeton"] = Number(row["Princeton University"])
        newRow["UPenn"] = Number(row["University of Pennsylvania"])
        newRow["Yale"] = Number(row["Yale University"])

        return newRow;
      }

      function callback(error, rawData) {
        data = rawData;

        year = d3.nest()
        .key(function (d) { return d.Year; })
        .entries(data);

        race = d3.nest()
        .key(function (d) { return d.Race; })
        .entries(data);

        gender = d3.nest()
        .key(function (d) { return d.Gender; })
        .entries(data);

        createVisualization("1");
        createVisualization("2");
      }


      /* Helper functions for translating and rotating with inputs */
      function translate (x,y) { return "translate(" + x + "," + y + ")"; };
      function rotate (a,x,y) { return "rotate(" + a + " " + x + "," + y + ")"};


      // to access a particular school based on a particular year and race use:
      // Object.values(year[0])[1][13].Cornell
      // year[0] - the actual year
      // [1] - the value list
      // [13] - the 14th object ("race")
      // .Cornell pulls value for particular school

      //don't think we need school_list or school_maps anymore
      var school_list= ["Columbia", "Dartmouth", "Brown", "Cornell",
                        "Harvard", "Princeton", "UPenn", "Yale"]
      // var school_maps = [];

      function createVisualization(num) {

        var winHeight = window.innerHeight-10;
        var winWidth = window.innerWidth-10;
        var side = Math.min(winHeight,winWidth);
        
        //for makeDataSchool
        //Will store race names as the value, index number as key
        //Indexes will match the keys of the data created in makeDataSchool
        var racedic = d3.map();

        // year from slider
        var yearInput= 0;

        var slideInput = d3.select("#slider"+num)
          .on("input", function(){
            //Corresponds with a value 0-22 (this value goes in the x for year[x] in the comment above)
            yearInput = this.value - 1996;
            //perform update
            render()
          });

        // school name from radio buttons
        var schoolInput = "Cornell";
        var radioInput = d3.selectAll("#schoolName" + num)
          .on("change", function(){
            schoolInput = this.value;
            render()
          });

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        // draw and append the container
        // play with width/height percentages to make room for buttons/sliders/selectors
        // **must be percentages to work with viewBox;
        var svg = d3.select("#donut"+num)
          .attr("width", "75%")   // each svg takes up 50% of the window
          .attr("height", "75%")  // each svg takes up 75% of the window
          .attr("viewBox", "0 0 "+side+" "+side);   // allows for relative resizing

        // set the thickness of the inner and outer radii
        var oRadius = side / 2;
        var iRadius = side / 2.75;

        // construct arc generator
        var arc = d3.arc()
          .outerRadius(oRadius)
          .innerRadius(iRadius);

        // creates the pie chart container
        var g = svg.append("g")
          .attr("transform", translate(side/2,side/2));

        // construct default pie laoyut
        var pie = d3.pie().value(function(d){ return d; }).sort(null);
        // grab data
        var donut_data= makeDataSchool(school_list);

        // enter data
        var paths = g.datum(donut_data).selectAll("path")
          .data(pie(donut_data))

        // remove data if unneeded
        paths.exit().remove();

        // create/update pie chart
        var pathG = paths.enter().append("g");
        pathG.append("path")
            .attr("class","piechartArcs")
          .merge(pathG)
            .attr("d", arc)
            .attr("fill", function(d,i){ return color(i); })
            .each(function(d,i) {
              this._current = d;

              // add a hidden arc for each section, extended, for labelling
              // unsure if there's a better way, right now it looks like every section
              //   adds hidden arcs for every section--so there's section*section arcs?
              var newArc = d3.arc()
                .outerRadius(oRadius)
                .innerRadius(iRadius)
                .startAngle(arc.startAngle()(d))
                .endAngle(arc.endAngle()(d)+50);

              //Create a new invisible arc that the text can flow along
              /*pathG.append("path")
                .attr("class", "hiddenArcs")
                .attr("id", "arc"+i)
                .attr("d", newArc)
                .style("fill", "none");*/
            })

        // https://www.visualcinnamon.com/2015/09/placing-text-on-arcs.html
        // Add labels
        pathG.append("text")
            .attr("class","piechartLabels")
            // .attr("x", 25)
            // .attr("startOffset","50%")
            // .style("text-anchor","middle")
            .attr("dy", -13)
          .merge(pathG)
            .append("textPath")
            .attr("xlink:href",function(d,i){return "#arc"+i;})
            .text(function(d) { return racedic.get(d.index); })
            // .on("mouseover", function (d) {
            //     // this.attr('visibility', 'visible');
            // })

        pathG.append("image")
          .attr("width","50%")
          .attr("height","50%")
          .attr("x","-25%")
          .attr("y","-25%")
          .attr("xlink:href", "images/Cornell.png");

        function render() {

          // generate new random data
          //donut_data = makeData(+document.getElementById("datacount").value);
          donut_data = makeDataSchool(school_list);
          // add transition to new path
          g.datum(donut_data).selectAll("path")
            .data(pie)
            .transition().duration(1000)
            .attrTween("d", arcTween)
          // add any new paths
          g.datum(donut_data).selectAll("path")
            .data(pie)
            .enter().append("path")
            .attr("class","piechart")
            .attr("fill", function(d,i){ return color(i); })
            .attr("d", arc)
            .each(function(d){ this._current = d; })
          // remove data not being used
          g.datum(donut_data).selectAll("path")
            .data(pie).exit().remove();

          svg.selectAll("image").remove();
          var image = svg.selectAll("image")
            .data([schoolInput]);
          image.enter()
            .append("image")
              .attr("width","50%")
              .attr("height","50%")
              .attr("x","25%")
              .attr("y","25%")
            .merge(image)
              .attr("xlink:href", "images/"+schoolInput+".png");

        }
        // render();
        //setInterval(render,2000);

        //the circle should be the diversity distribution from the school
        //selected, during the selected year
        function makeDataSchool(school_list){
          //will use yearInput in place of the 0 in all of the following
          var races= Object.values(year[yearInput])[1];
          returnedData = d3.range(races.length).map(function(item) {
            var rac = Object.values(year[yearInput])[1][item];
            var abvName = rac.RaceName;
            racedic.set(item, abvName);
            return Object.values(year[yearInput])[1][item][schoolInput];
          });
          return returnedData;
        };

        // Store the displayed angles in _current.
        // Then, interpolate from _current to the new angles.
        // During the transition, _current is updated in-place by d3.interpolate.
        function arcTween(a) {
          var i = d3.interpolate(this._current, a);
          this._current = i(0);
          return function(t) {
            return arc(i(t));
          };
        }
      }

    </script>
  </body>
</html>