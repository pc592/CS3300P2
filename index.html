<html>
  <head>
    <title>INFO 3300 - Data-driven Web Pages</title>
    <script src="https://d3js.org/d3.v4.min.js"></script>
  </head>

  <style>
    body { font-family: Arial, sans-serif; font-size: 12;}
  </style>

  <body>
    <!--<div>
      Number of datapoints:
      <input id="datacount" onkeyup="render()" value="15" name="datapoints"></input>
    </div>-->
    <!-- <input id ="slider1" type="range" min="1996" max="2016" value = "2005"> -->
    <!-- <input id ="slider2" type="range" min="1996" max="2016" value = "2005"> -->
    <script>
      var data;
      var year;
      var race;
      var gender;

      d3.csv("/data/RaceByYear.csv", parseRow, callback);

      function parseRow(row) {
        var newRow = {};
        newRow["Gender"] = row["Gender"]
        newRow["Race"] = row["Race"]
        newRow["Year"] = Number(row["Year"])
        newRow["Brown"] = Number(row["Brown University"])
        newRow["Columbia"] = Number(row["Columbia University in the City of New York"])
        newRow["Cornell"] = Number(row["Cornell University"])
        newRow["Dartmouth"] = Number(row["Dartmouth College"])
        newRow["Harvard"] = Number(row["Harvard University"])
        newRow["Princeton"] = Number(row["Princeton University"])
        newRow["UPenn"] = Number(row["University of Pennsylvania"])
        newRow["Yale"] = Number(row["Yale University"])
        // console.log(newRow)
        return newRow;
      }

      function callback(error, rawData) {
        data = rawData;

        year = d3.nest()
        .key(function (d) { return d.Year; })
        .entries(data);

        race = d3.nest()
        .key(function (d) { return d.Race; })
        .entries(data);

        gender = d3.nest()
        .key(function (d) { return d.Gender; })
        .entries(data);

        createVisualization("1");
        createVisualization("2");
      }

      function prettyPrintRaceName(d) {
        if (d.Gender == "Male") {
          return d.Race.split(' men')[0];
        } else {
          return d.Race.split(' women')[0];
        }
      }

      // to access a particular school based on a particular year and race use: 
      // Object.values(year[0])[1][13].Cornell
      // year[0] - the actual year
      // [1] - the value list
      // [13] - the 14th object ("race")
      // .Cornell pulls value for particular school

      //don't think we need school_list or school_maps anymore
      var school_list= ["Columbia", "Dartmouth", "Brown", "Cornell", "Harvard", "Princeton", "UPenn", "Yale"]
      // var school_maps = [];

      function createVisualization(num) {

        var slideInput = d3.select("#slider"+num).on("input", function(){
          console.log(this.value);
          //this needs to correspond with a value 0-23 (this value goes in the x for year[x] in the comment above)
          //this value along with a selected school will determine the data to display
          //perform update
        });

        winHeight = window.innerHeight-10;
        winWidth = window.innerWidth-10;
        var side = Math.min(winHeight,winWidth);

        var color = d3.scaleOrdinal(d3.schemeCategory10);

        // draw and append the container
        // play with width/height percentages to make room for buttons/sliders/selectors
        // **must be percentages to work with viewBox;
        var svg = d3.select("body").append("svg")
          .attr("id","graph"+num)
          .attr("width", "50%")   // each svg takes up 50% of the window
          .attr("height", "75%")  // each svg takes up 75% of the window
          .attr("viewBox", "0 0 "+side+" "+side);

        // set the thickness of the inner and outer radii
        var oRadius = side / 2;
        var iRadius = side / 2.75;

        // construct default pie laoyut
        var pie = d3.pie().value(function(d){ return d; }).sort(null);

        // construct arc generator
        var arc = d3.arc()
          .outerRadius(oRadius)
          .innerRadius(iRadius);

        // creates the pie chart container
        var g = svg.append('g')
          .attr('transform', function(){
            return 'translate(' + side/2 + ',' + side / 2 + ')';
          })

        // grab data
        var donut_data= makeDataSchool(school_list);
        //var donut_data = makeData(+document.getElementById("datacount").value);
        console.log(donut_data)

        // enter data and draw pie chart
        var path = g.datum(donut_data).selectAll("path")
          .data(pie)
          .enter().append("path")
            .attr("class","piechart")
            .attr("fill", function(d,i){ return color(i); })
            .attr("d", arc)
            .each(function(d){ this._current = d; })

        function render(){
          // generate new random data
          //donut_data = makeData(+document.getElementById("datacount").value);
          donut_data= makeDataSchool(school_list)
          // add transition to new path
          g.datum(donut_data).selectAll("path").data(pie).transition().duration(1000).attrTween("d", arcTween)
          // add any new paths
          g.datum(donut_data).selectAll("path")
            .data(pie)
          .enter().append("path")
            .attr("class","piechart")
            .attr("fill", function(d,i){ return color(i); })
            .attr("d", arc)
            .each(function(d){ this._current = d; })
          // remove data not being used
          g.datum(donut_data).selectAll("path")
            .data(pie).exit().remove();
        }
        render();
        setInterval(render,2000);
        function makeData(size){
          return d3.range(size).map(function(item){
           return Math.random()*100;
          });
        };

        //the circle should be the diversity distribution from the school
        //selected, during the selected year
        function makeDataSchool(school_list){
          return d3.range(school_list.length).map(function(item) {
            //console.log(school_list[item]);
            //console.log(data[0]);
            return data[0][school_list[item]];
          });
        };

        // Store the displayed angles in _current.
        // Then, interpolate from _current to the new angles.
        // During the transition, _current is updated in-place by d3.interpolate.
        function arcTween(a) {
          var i = d3.interpolate(this._current, a);
          this._current = i(0);
          return function(t) {
            return arc(i(t));
          };
        }
      }

    </script>
  </body>
</html>